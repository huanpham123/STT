<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flask STT Demo (SpeechRecognition)</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    #controls {
      margin-bottom: 15px;
    }
    #record-btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    #record-btn.recording {
      background-color: #dc3545;
    }
    #status {
      margin-left: 10px;
      font-weight: bold;
    }
    #transcript {
      margin-top: 20px;
      font-size: 18px;
      color: #333;
      white-space: pre-wrap;
    }
  </style>

  <!-- T√¥i d√πng Recorder.js (phi√™n b·∫£n 0.1.0) ƒë·ªÉ xu·∫•t WAV tr·ª±c ti·∫øp -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recorderjs/0.1.0/recorder.min.js"
          integrity="sha512-AEAywwOWVkFMKLM5TaZ4VWA8KYdtc2tOfNQZvrCXcYHR4N6tUaO50O54B24sJn6z5ktdCX6UisHaXN/RJM13ig=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <h1>Demo STT (Flask + speech_recognition)</h1>

  <div id="controls">
    <button id="record-btn">üé§ B·∫Øt ƒë·∫ßu ghi √¢m</button>
    <span id="status">Ch∆∞a ghi √¢m</span>
  </div>

  <div id="transcript">B·∫£n phi√™n √¢m s·∫Ω hi·ªán ·ªü ƒë√¢y ‚Ä¶</div>

  <script>
    // --- Bi·∫øn to√†n c·ª•c cho ghi √¢m ---
    let audioContext;
    let gumStream;
    let inputPoint;
    let recorder;

    const recordBtn = document.getElementById("record-btn");
    const statusSpan = document.getElementById("status");
    const transcriptDiv = document.getElementById("transcript");

    let isRecording = false;

    recordBtn.addEventListener("click", () => {
      if (!isRecording) {
        startRecording();
      } else {
        stopRecording();
      }
    });

    function startRecording() {
      // Y√™u c·∫ßu quy·ªÅn s·ª≠ d·ª•ng microphone
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          gumStream = stream;
          inputPoint = audioContext.createMediaStreamSource(stream);

          // Kh·ªüi t·∫°o Recorder.js (ghi RAW PCM v√† xu·∫•t WAV)
          recorder = new Recorder(inputPoint, { numChannels: 1 });
          recorder.record();

          isRecording = true;
          recordBtn.textContent = "‚ñ† D·ª´ng ghi √¢m";
          recordBtn.classList.add("recording");
          statusSpan.textContent = "ƒêang ghi √¢m...";
          transcriptDiv.textContent = "";
        })
        .catch(err => {
          console.error("Kh√¥ng th·ªÉ truy c·∫≠p microphone: " + err);
          alert("Kh√¥ng th·ªÉ truy c·∫≠p microphone: " + err);
        });
    }

    function stopRecording() {
      // D·ª´ng thu, t·∫°o Blob WAV
      recorder.stop();
      gumStream.getAudioTracks()[0].stop();

      recordBtn.textContent = "üé§ B·∫Øt ƒë·∫ßu ghi √¢m";
      recordBtn.classList.remove("recording");
      statusSpan.textContent = "ƒêang x·ª≠ l√Ω‚Ä¶";

      // Xu·∫•t blob WAV
      recorder.exportWAV(blob => {
        // G·ª≠i blob WAV l√™n server ƒë·ªÉ transcribe
        sendToServer(blob);
      });

      isRecording = false;
    }

    function sendToServer(wavBlob) {
      // T·∫°o FormData v√† ƒë√≠nh k√®m file WAV
      const fd = new FormData();
      fd.append("audio_data", wavBlob, "recording.wav");

      fetch("/transcribe", {
        method: "POST",
        body: fd
      })
      .then(response => response.json())
      .then(data => {
        if (data.transcript !== undefined) {
          transcriptDiv.textContent = data.transcript;
          statusSpan.textContent = "Ho√†n t·∫•t.";
        } else if (data.error) {
          transcriptDiv.textContent = "L·ªói: " + data.error;
          statusSpan.textContent = "L·ªói.";
        } else {
          transcriptDiv.textContent = "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c transcript.";
          statusSpan.textContent = "Xong.";
        }
      })
      .catch(err => {
        console.error("L·ªói g·ª≠i l√™n server:", err);
        transcriptDiv.textContent = "L·ªói khi g·ªçi /transcribe: " + err;
        statusSpan.textContent = "L·ªói.";
      });
    }
  </script>
</body>
</html>
